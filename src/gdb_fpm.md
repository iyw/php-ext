##使用gdb调试fpm

####1.背景
最近线上发现一个奇葩问题、opcache_reset 清理cache的时候，导致php-fpm进程杀掉,出现段错误，看报错：

php-fpm报错如下
```shell
[17-Jul-2017 22:31:29] WARNING: [pool linkapi.fang.lianjia.com] child 10306 said into stderr: "zend_mm_heap corrupted"
[17-Jul-2017 22:31:29] WARNING: [pool linkapi.fang.lianjia.com] child 10306 exited with code 1 after 0.373182 seconds from start
[17-Jul-2017 22:31:29] NOTICE: [pool linkapi.fang.lianjia.com] child 10309 started
[17-Jul-2017 22:31:30] WARNING: [pool linkapi.fang.lianjia.com] child 10309 exited on signal 11 (SIGSEGV - core dumped) after 0.807603 seconds from start
```

nginx错误日志报错如下

```
2017/07/18 12:03:40 [error] 16253#0: *149718 recv() failed (104: Connection reset by peer) while reading response header from upstream, client: 10.33.73.2, server: dev.linkapi.lianjia.com, request: "GET /api/link/agentinfo?agent_id=1000000020205158 HTTP/1.0", upstream: "fastcgi://127.0.0.1:9040", host: "dev.linkapi.lianjia.com"
2017/07/18 12:03:40 [error] 16253#0: *149645 recv() failed (104: Connection reset by peer) while reading response header from upstream, client: 10.33.73.2, server: dev.linkapi.lianjia.com, request: "GET /api/link/agentinfo?agent_id=1000000020205158 HTTP/1.0", upstream: "fastcgi://127.0.0.1:9040", host: "dev.linkapi.lianjia.com"
```
####2.设置coredump

```shell
core文件存储路径和格式
echo "/tmp/core-%e-%p" > /proc/sys/kernel/core_pattern

控制pid是否作为扩展名
echo "1" > /proc/sys/kernel/core_uses_pid

更改大小限制,不然core文件生成的时候会被截断
在文件 /etc/security/limits.conf中加入

# End of file
* soft nofile 65534
* hard nofile 65534
* soft core unlimited
* hard core unlimited


退出终端再重新进入生效 输入下面命令提示unlimited  就对了
[root@lianjia ~]# ulimit -c
unlimited

```

####3.设置php-fpm

```shell

vim /usr/local/matrix/etc/php-fpm.conf
找的关键字 rlimit_core  并修改为

rlimit_core = unlimited

重启fpm
```

####4.追踪
测试完，在/tmp目录下面已经生成一些core文件
```
[root@lianjia ~]# tree /tmp
/tmp
├── core-php-fpm.16568
├── core-php-fpm.4990
├── core-php-fpm.5953
├── core-php-fpm.6031
├── core-php-fpm.6866
└── pear
    └── temp

    2 directories, 5 files

```

执行命令
```
gdb /usr/local/matrix/sbin/php-fpm  /tmp/core-php-fpm.6031 

```

用bt就可以查看日志了

```
Reading symbols from /usr/local/matrix/lib/php/extensions/no-debug-non-zts-20121212/yar.so...(no debugging symbols found)...done.
Loaded symbols for /usr/local/matrix/lib/php/extensions/no-debug-non-zts-20121212/yar.so
Reading symbols from /usr/local/matrix/lib/php/extensions/no-debug-non-zts-20121212/yac.so...(no debugging symbols found)...done.
Loaded symbols for /usr/local/matrix/lib/php/extensions/no-debug-non-zts-20121212/yac.so
Reading symbols from /usr/local/matrix/lib/php/extensions/no-debug-non-zts-20121212/phalcon.so...(no debugging symbols found)...done.
Loaded symbols for /usr/local/matrix/lib/php/extensions/no-debug-non-zts-20121212/phalcon.so
Reading symbols from /lib64/libnss_files.so.2...Reading symbols from /usr/lib/debug/lib64/libnss_files-2.12.so.debug...done.
done.
Loaded symbols for /lib64/libnss_files.so.2
Core was generated by `php-fpm: pool linkapi.fang.lianjia.com                                        '.
Program terminated with signal 11, Segmentation fault.
#0  zend_mm_add_to_free_list (heap=<value optimized out>, mm_block=0x7f517b15f0f8) at /root/build/php-5.5.38/Zend/zend_alloc.c:752
752                 if (ZEND_MM_FREE_BLOCK_SIZE(prev) != size) {
    Missing separate debuginfos, use: debuginfo-install matrix-php-5.5.38-3.x86_64
        (gdb) bt
#0  zend_mm_add_to_free_list (heap=<value optimized out>, mm_block=0x7f517b15f0f8) at /root/build/php-5.5.38/Zend/zend_alloc.c:752
#1  0x00000000006a9cd2 in _zend_mm_free_int (heap=0x26b2330, p=0x7f517b15f5a8) at /root/build/php-5.5.38/Zend/zend_alloc.c:2118
#2  0x00000000006ddff1 in zend_hash_destroy (ht=0x7f517b15f040) at /root/build/php-5.5.38/Zend/zend_hash.c:565
#3  0x0000000000781212 in fcgi_close (req=0x7ffe1830bbc0, force=<value optimized out>, destroy=<value optimized out>)
            at /root/build/php-5.5.38/sapi/fpm/fpm/fastcgi.c:726
#4  0x000000000078174f in fcgi_finish_request (req=0x7ffe1830bbc0, force_close=0) at /root/build/php-5.5.38/sapi/fpm/fpm/fastcgi.c:1078
#5  0x0000000000789a62 in sapi_cgi_deactivate () at /root/build/php-5.5.38/sapi/fpm/fpm/fpm_main.c:851
#6  0x000000000067babc in sapi_deactivate () at /root/build/php-5.5.38/main/SAPI.c:536
#7  0x0000000000672385 in php_request_shutdown (dummy=<value optimized out>) at /root/build/php-5.5.38/main/main.c:1822
#8  0x000000000078ab49 in main (argc=<value optimized out>, argv=<value optimized out>) at /root/build/php-5.5.38/sapi/fpm/fpm/fpm_main.c:1981

```

